---
output: github_document
---
<!-- implan-transfer.md is generated from implan-transfer.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(dplyr)
library(implan)
```

# Overview

The implan package streamlines several steps otherwise done in Excel:

1. [Prepare](#1-prepare-implan-sector-allocation): Allocate spending by Implan sector and validate using `implan::check` functions.
2. [Input](#2-input-write-to-excel): Write Excel tabs for Implan import using `implan::input()`
3. [Output](#3-output-read-from-implan): Pull all Implan output (csv) into a table using `implan::output()`

### Elevator Pitch

R code can be easily scaled up/down or ported to a new project without the manual restructuring needed in Excel. It also facilitates automated checks/summaries. You can see a production example for B4W-19-01:   [implan-input](https://github.com/southwick-associates/B4W-19-01/blob/master/code/implan/1-implan-input.R), [contributions](https://github.com/southwick-associates/B4W-19-01/blob/master/code/implan/2-contributions.R)

### Resources

There is an Office 365 group with useful files ([O365 > Implan](https://southwickassociatesinc.sharepoint.com/sites/Implan)) including master sectoring schemes (i.e., category to sector crosswalks). I've also included template files from the Excel approach in this package (details in [the last section](#excel-approach)).

### Example Data

The implan package includes example data for demonstration. The starting point is a table of total spending estimates by activity-type-item. The `activity_group` variable is included for joining with the item_to_category crosswalk table described below.

```{r}
library(dplyr)
library(implan)

data(spending) # spending by activity-type-item
spending
```

## 1. Prepare Implan Sector Allocation

Allocating spending to Implan sectors requires a spending table and 2 crosswalk tables. The implan package includes example data to demonstrate the allocation process:

### Item to Category

Spending must first be reallocated from the item level (e.g., from survey data) to the category level (e.g., "Food - Groceries", etc.) using an item-to-category crosswalk. 

Items in the example data mostly have a 1-to-1 correspondence with categories, but several need to be split into multiple categories (e.g., food), so we need a `share` variable to specify the breakout percentages. The crosswalk is specified by 3 dimensions (`activity_group`, `type`, `item`) across which `share` must sum to 100%. We can confirm this using `check_share_sums()`:

```{r}
data(item_to_category)
head(item_to_category, 2)

# check the share variable - should print "TRUE"
check_share_sums(df = item_to_category, sharevar = share, activity_group, type, item)
```

Allocating is a simple matter of joining the spending and crosswalk tables and then multiplying. We can use `check_spend_sums()` to confirm that expenditures still sum to the correct quantities after we modify the data.

```{r}
spend_category <- spending %>%
    left_join(item_to_category, by = c("activity_group", "type", "item")) %>%
    mutate(spend = spend * share) %>%
    select(-share) # no longer needed

head(spend_category, 2)

# check the spending allocation - should print "TRUE"
check_spend_sums(df_old = spending, df_new = spend_category, spendvar = spend, 
                 activity_group, type, item)
```

### Category to Sector

In the same way, allocating to sectors uses a category-to-sector crosswalk (also referred to as an implan sectoring scheme). Note that dated versions of sectoring schemes are stored in [O365 > Implan > Sectoring Schemes](https://southwickassociatesinc.sharepoint.com/:f:/s/Implan/EnL9nwfijuROuo34BCV47fkB9yuOh8l0lDdaEtmEfL9TNA?e=R2dby9)) and these can be used directly (or with minor modifications) for any given project.

```{r}
data(category_to_sector546)
head(category_to_sector546, 2)

check_share_sums(category_to_sector546, sharevar = share, category)

spend_sector <- spend_category %>%
    left_join(category_to_sector546, by = "category") %>%
    mutate(spend = spend * share)

check_spend_sums(df_old = spend_category, df_new = spend_sector, spendvar = spend, category)
```

## 2. Input Write to Excel

To prepare for implan import, we first convert spending by sector to the necessary Industry/Commodity format using `input_prep_ind()`. Each destination Excel tab requires two tables (header & data), so `input_prep_ind()` returns a list of two data frames.:

```{r}
ind <- input_prep_ind(spend_sector, "Ind")
comm <- input_prep_comm(spend_sector, "Comm")

comm$header

head(comm$dat, 2)
```

After prepartion, the data can be written to Excel with `xlsx_write_implan()`. Note that when you are ready for Implan import, you'll first need to open the `.xlsx` file and save to the legacy `.xls` format which Implan requires.

```{r}
xlsx_write_implan(comm, "tmp.xlsx")
xlsx_write_implan(ind, "tmp.xlsx")

openxlsx::getSheetNames("tmp.xlsx")
```

It's also easy to create multiple Excel sheets corresponding to whatever dimensions are required for the project. For example, by activity:

```{r}
acts <- sort(unique(spend_sector$act))
for (i in acts) {
    df <- filter(spend_sector, act == i)
    input_prep_ind(df, paste0(i, "Ind")) %>% xlsx_write_implan("tmp2.xlsx")
    input_prep_comm(df, paste0(i, "Comm")) %>% xlsx_write_implan("tmp2.xlsx")
}
openxlsx::getSheetNames("tmp2.xlsx")
```

And, of course, we can further scale-up the dimensions. For example, let's assume we also need to save multiple excel files, trip vs equip separately. Here I first make a function to wrap the by-activity loop above. I also generalized it to work at any dimension since I suspect it could be useful for multiple projects. The function can then be applied to produce multiple Excel files:

```{r}
# write implan sheets an excel file, one sheet per dimension for each group (Ind vs Comm)
write_dims <- function(spend_sector, outfile, dimension = "act") {
    dims <- sort(unique(spend_sector[[dimension]]))
    for (i in dims) {
        df <- filter(spend_sector, .data[[dimension]] == i)
        input_prep_ind(df, paste0(i, "Ind")) %>% xlsx_write_implan(outfile)
        input_prep_comm(df, paste0(i, "Comm")) %>% xlsx_write_implan(outfile)
    }
}
for (i in c("trip", "equip")) {
    write_dims(
        spend_sector = filter(spend_sector, type == i),
        outfile = paste0("tmp-", i, ".xlsx")
    )
}
list.files(pattern = "\\.xlsx")
```

Note that for the above code, we could have used a nested loop with two iterators (e.g., i,j). I tend to avoid such nesting because things can get confusing quickly. Making code more modular (by using functions) tends to make it more intelligible and portable (e.g., to other projects).

## 3. Output Read from Implan

From Implan, you'll need to save output results into csv files, where each Implan activity should have its own folder of results. Two example activities are included in this package:

```{r}
output_dir <- system.file("extdata", "output", package = "implan", mustWork = TRUE)
list.files(output_dir)
```

Typically, you'll want 5 sets of results per activity:

```{r}
hunt_dir <- file.path(output_dir, "hunt")
list.files(hunt_dir)
```

### Get CSV Files

The `output_read_csv()` function pulls all csv files for an activity into an R list, with one data frame per input file. The names of the list correspond to a title row that Implan includes in the output csv files:

```{r}
dat <- output_read_csv(hunt_dir)
names(dat)
```

You can then combine these results into a single summary table with `output_combine()`:

```{r}
output_combine(dat)
```

It's easy to scale-up this operation using a for loop (or `sapply`):

```{r}
impacts <- list()
for (i in c("bike", "hunt")) {
  impacts[[i]] <- output_read_csv(file.path(output_dir, i)) %>% 
    output_combine() %>% 
    mutate(activity = i)
}
bind_rows(impacts)
```

## Excel Approach

The Excel approach combines steps 1 & 2 into an Excel workbook. I included a basic example (for wildlife watching) in this package:

```{r}
filepath <- system.file(
  "extdata", "templates", "fhwar-implan-import.xls", package = "implan", mustWork = TRUE
)
file.copy(filepath, "tmp.xls") # copy to your working directory
```

Step 3 can be accomplished by copy/pasting implan results into an Excel sheet and running embedded macros:

```{r}
filepath <- system.file(
  "extdata", "templates", "implan-output.xlsm", package = "implan", mustWork = TRUE
)
file.copy(filepath, "tmp.xlsm") # copy to your working directory
```

