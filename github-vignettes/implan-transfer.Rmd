---
output: github_document
---
<!-- implan-transfer.md is generated from implan-transfer.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(dplyr)
library(implan)
```

## Overview

The implan package streamlines the steps otherwise done in Excel:

1. [Allocate spending by Implan sector](#implan-sector-allocation)
2. [Write Excel tabs for Implan import](#write-to-excel)
3. [Pull all Implan output (csv) into one table](#read-from-csv)

### Elevator Pitch

R code can be easily scaled up/down or ported to a new project without the manual restructuring needed in Excel. It's also less error-prone and facilitates automated checks/summaries.

## Implan Sector Allocation

Allocating spending to Implan sectors requires 1 or more crosswalk tables. The implan package includes example data to demonstrate the allocation process. You can use `read_excel` from the [readxl package](https://readxl.tidyverse.org/) for data stored in Excel.

```{r}
library(dplyr)
library(implan)

data(spending) # total hunting spending by item
head(spending, 2)
```

### Categories

For the sample data, spending must first be reallocated from the "item" level to the "category" level. Spending is specified by 2 dimensions (`type`, `item`) for which `share` must sum to 100%:

```{r}
data(categories) # category crosswalk
head(categories, 2)

# check the share variable - should print "TRUE"
check_share_sums(df = categories, sharevar = share, type, item)
```

Allocating is a simple matter of joining with the crosswalk table and multiplying:

```{r}
spend_category <- spending %>%
    left_join(categories, by = c("type", "item")) %>%
    mutate(spend = spend * share) %>%
    select(-share) # no longer needed

head(spend_category, 2)

# check the spending allocation - should print "TRUE"
check_spend_sums(df_old = spending, df_new = spend_category, spendvar = spend, type, item)
```

### Sectors

In the same way, allocating to sectors uses a sectoring scheme crosswalk (at the `category` dimension):

```{r}
data(sector_scheme546) # implan sector crosswalk
head(sector_scheme546, 2)

check_share_sums(sector_scheme546, sharevar = share, category)

spend_sector <- spend_category %>%
    left_join(sector_scheme546, by = "category") %>%
    mutate(spend = spend * share)

check_spend_sums(df_old = spend_category, df_new = spend_sector, spendvar = spend, category)
```

## Write to Excel

A preparation step is needed to convert spending by sector to the Industry/Commercial format that the Implan import requires:

```{r}
ind <- input_prep_ind(spend_sector, "huntInd")
comm <- input_prep_comm(spend_sector, "huntComm")

# 2 tables are needed for each Excel tab
comm$header

head(comm$dat, 2)
```

After prepartion, the data can be written to Excel with `xlsx_write_implan()`. Note that you'll need to open the `.xlsx` file and save as `.xls` prior to Implan import.

```{r}
xlsx_write_implan(comm, "tmp.xlsx")
xlsx_write_implan(ind, "tmp.xlsx")

openxlsx::getSheetNames("tmp.xlsx")
```

It's also easy to create tabs at whatever dimension is required for the project:

```{r}
for (i in c("trip", "equip")) {
    x <- filter(spend_sector, type == i)
    input_prep_ind(x, paste0(i, "Ind")) %>% xlsx_write_implan("tmp2.xlsx")
    input_prep_comm(x, paste0(i, "Comm")) %>% xlsx_write_implan("tmp2.xlsx")
}
openxlsx::getSheetNames("tmp2.xlsx")
```

## Read from CSV

```{r}

```

