---
output: github_document
---
<!-- implan-transfer.md is generated from implan-transfer.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(dplyr)
library(implan)
```

## Overview

The implan package streamlines several steps otherwise done in Excel:

1. [Allocate spending by Implan sector](#implan-sector-allocation)
2. [Write Excel tabs for Implan import](#write-to-excel)
3. [Pull all Implan output (csv) into one table](#read-from-implan)

### Elevator Pitch

R code can be easily scaled up/down or ported to a new project without the manual restructuring needed in Excel. It's also less error-prone and facilitates automated checks/summaries. You can see an example in the wild for B4W:   [implan-input](https://github.com/southwick-associates/B4W-19-01/blob/master/code/implan/1-implan-input.R), [contributions](https://github.com/southwick-associates/B4W-19-01/blob/master/code/implan/2-contributions.R)

I've also included Excel files from the older approach in this package (details in [the last section](#excel-approach)).

## Implan Sector Allocation

### TODO: Explain in a more informative way

1. Discuss sectoring schemes (category-to-sector) and how these:
  + probably won't vary by project (unless need categories need to be added)
  + the categories define the target for the item-to-category crosswalk
  + include the check_share_sums (TRUE if sums to 100%)
2. Discuss item-category crosswalk:
  + this may need to be constructed by hand, unless an item-breakout from an existing projects (e.g., OIA) is used
3. Allocate (this is simple)

Allocating spending to Implan sectors requires 1 or more crosswalk tables. The implan package includes example data to demonstrate the allocation process:

```{r}
library(dplyr)
library(implan)

data(spending) # total hunting spending by item
spending
```

### Item to Category

For the sample data, spending must first be reallocated from the "item" level to the "category" level. Spending is specified by 2 dimensions (`type`, `item`) for which `share` must sum to 100%:

```{r}
data(item_to_category)
head(item_to_category, 2)

# check the share variable - should print "TRUE"
check_share_sums(df = item_to_category, sharevar = share, type, item)
```

Allocating is a simple matter of joining with the crosswalk table and multiplying:

```{r}
spend_category <- spending %>%
    left_join(item_to_category, by = c("type", "item")) %>%
    mutate(spend = spend * share) %>%
    select(-share) # no longer needed

head(spend_category, 2)

# check the spending allocation - should print "TRUE"
check_spend_sums(df_old = spending, df_new = spend_category, spendvar = spend, type, item)
```

### Category to Sector

In the same way, allocating to sectors uses a crosswalk (at the `category` dimension):

```{r}
data(category_to_sector546)
head(category_to_sector546, 2)

check_share_sums(category_to_sector546, sharevar = share, category)

spend_sector <- spend_category %>%
    left_join(category_to_sector546, by = "category") %>%
    mutate(spend = spend * share)

check_spend_sums(df_old = spend_category, df_new = spend_sector, spendvar = spend, category)
```

## Write to Excel

We must first convert spending by sector to the necessary Industry/Commodity format. Each destination Excel tab requires 2 tables (header & data):

```{r}
ind <- input_prep_ind(spend_sector, "huntInd")
comm <- input_prep_comm(spend_sector, "huntComm")

comm$header

head(comm$dat, 2)
```

After prepartion, the data can be written to Excel with `xlsx_write_implan()`. Note that you'll need to open the `.xlsx` file and save as `.xls` prior to Implan import.

```{r}
xlsx_write_implan(comm, "tmp.xlsx")
xlsx_write_implan(ind, "tmp.xlsx")

openxlsx::getSheetNames("tmp.xlsx")
```

It's also easy to create tabs at whatever dimension is required for the project:

```{r}
for (i in c("trip", "equip")) {
    x <- filter(spend_sector, type == i)
    input_prep_ind(x, paste0(i, "Ind")) %>% xlsx_write_implan("tmp2.xlsx")
    input_prep_comm(x, paste0(i, "Comm")) %>% xlsx_write_implan("tmp2.xlsx")
}
openxlsx::getSheetNames("tmp2.xlsx")
```

## Read from Implan

From Implan, you'll need to save output results into csv files, where each Implan activity should have its own folder of results. Two example activities are included in this package:

```{r}
output_dir <- system.file("extdata", "output", package = "implan", mustWork = TRUE)
list.files(output_dir)
```

Typically, you'll want 5 sets of results per activity:

```{r}
hunt_dir <- file.path(output_dir, "hunt")
list.files(hunt_dir)
```

### Get CSV Files

The `output_read_csv()` function pulls all csv files for an activity into an R list:

```{r}
dat <- output_read_csv(hunt_dir)
names(dat)
```

You can then combine these results into a single table with `output_combine()`:

```{r}
output_combine(dat)
```

It's easy to scale-up this operation using a for loop (or `sapply`):

```{r}
impacts <- list()
acts <- list.files(output_dir)
for (i in acts) {
  impacts[[i]] <- output_read_csv(file.path(output_dir, i)) %>% 
    output_combine() %>% 
    mutate(activity = i)
}
bind_rows(impacts)
```

## Excel Approach

The older approach combines steps 1 & 2 into an Excel workbook. I included a basic example in this package (these become much more complex when scaling up):

```{r}
filepath <- system.file(
  "extdata", "templates", "fhwar-implan-import.xls", package = "implan", mustWork = TRUE
)
file.copy(filepath, "tmp.xls") # copy to your working directory
```

Step 3 can be accomplished by copy/pasting implan results into an Excel sheet and running embedded macros:

```{r}
filepath <- system.file(
  "extdata", "templates", "implan-output.xlsm", package = "implan", mustWork = TRUE
)
file.copy(filepath, "tmp.xlsm") # copy to your working directory
```

